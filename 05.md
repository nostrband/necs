# NEC-05 Code Release Signatures

Services running in AWS Nitro Enclave can report their `PCR values` in their attestations. The `PCR0`, `PCR1` and `PCR2` entries are the hashes of the code image. We are using these values to signal "approval" by code `maintainers`.

## Release Signature Event

Code `maintainers` may create a `kind:63792` event called `release signature` with tags `PCR0`, `PCR1` and `PCR2` that match the "approved" values of a particular code release. It SHOULD also and the `r` tag with a link to git repo, and `t` tag with `prod` or `dev` value (default - `dev`).  

FIXME use 2xxxx event, it's not for publishing

```js
{
  "id": <event id>,
  "created_at": <timestamp>,
  "pubkey": <maintainer pubkey>,
  "kind": 63792,
  "content": <optional comment>,
  "tags": [
    ["r", <git repo link>],
    ["t", <"prod" or "dev">],
    ["PCR0", <PCR0 from eif image>],
    ["PCR1", <PCR1 from eif image>],
    ["PCR2", <PCR2 from eif image>]
  ]
}
```

## Signature Usage

The `release signature` events MAY be included as `release` tags in `announcement` events of `kind:63793` ([NEC-02](./02.md)) so that clients could take the `maintainer` identities into account while discovering the services. In this case, it is recommended to also add `p` tags with `maintainer pubkey` and a `releaser` marker to the `announcement`.

```js
{
  "id": <event_id>,
  "create_at": <timestamp>,
  "pubkey": <service pubkey>,
  "kind": 63793,
  "content": <optional comment>,
  "tags":[
    ["tee_root", <attestation event>],
    ["release", "\{\"id\": <sig event id1>,\"created_at\": <timestamp>,\"pubkey\": <maintainer pubkey1>,\"kind\": 63792,\"content\": <optional comment>,\"tags\": \[\[\"r\",<git repo link>\],\[\"PCR0\", <PCR0>\],\[\"PCR1\", <PCR1>\],\[\"PCR2\", <PCR2>\]\]\}"],
    ["release", "\{\"id\": <sig event id2>,\"created_at\": <timestamp>,\"pubkey\": <maintainer pubkey2>,\"kind\": 63792,\"content\": <optional comment>,\"tags\": \[\[\"r\",<git repo link>\],\[\"PCR0\", <PCR0>\],\[\"PCR1\", <PCR1>\],\[\"PCR2\", <PCR2>\]\]\}"],
    ["p", <maintainer pubkey1>, "releaser"],
    ["p", <maintainer pubkey2>, "releaser"]
  ]
}
```

The `release signature` events SHOULD be injected into the service by the parent instance dynamically, as they cannot be statically hard-coded into the code image.

## Signature Validation

Clients that encounter the `announcement` events with `release signature` events included as `release` tags and AWS Nitro Enclave `attestation` included as `tee_root` tag MAY validate them by comparing the `PCR0`, `PCR1`, `PCR2`, `r` and `t` tags from the `release signature` with `PCR0`, `PCR1` and `PCR2` values from the `attestation` and `r` and `t` tags from the `announcement`. 

NOTE: `release signature` events discovered outside of `announcement` events MAY be used by clients as additional signal of approval by third parties.


